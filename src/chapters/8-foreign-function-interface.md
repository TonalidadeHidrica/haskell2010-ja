# 外部関数インターフェイス

外部関数インターフェイス(FFI)には2つの目的がある。(1)Haskellにおいて外部の言語の機能へのインターフェイスを記述できるようにすることと、(2)外部コードからHaskellの所定の手続きを利用できるようにすることである。より一般的には、その目的はHaskellとほかの言語を混ぜてプログラムの実装が書けるようにすることであり、その結果として、ソースコードがアーキテクチャやOSから独立するように、HaskellとHaskellでないシステムでの異なる実装を跨いだ移植性をソースコードが持つようにすることである。

## 外部言語

HaskellのFFIは現状、Haskellのコードと外部コードの間のやり取りをC言語の呼び出し規約に沿った形でしか指定できない。しかし、FFIは現在の定義を他の言語(C++やJavaなど)の呼び出し規約を含むようにモジュール拡張が可能な形でデザインされている。それらの言語のサポートの正確な定義は、Haskellの将来的なバージョンに含められることが期待される。2つ目の大きな省略は、外部言語におけるマルチスレッド(特にスレッドローカルの扱い)とのやり取りの定義である。よってこれらの詳細は現状では処理系定義である。

現在の仕様のコアは、Haskellと接続するのに使われる外部言語とは独立である。しかし、FFIの規格が言語依存に必ずなる2つの領域がある。(1)外部名称の規格と(2)外部言語の基本型のマーシャリングである。前者の例として、次のことを考えてみよ。C言語においては単純な識別子はオブジェクトを同定するのに十分である[9]が、一方でJavaでは、一般に可能なオーバーローディングの解決のために、修飾子付きの名前を引数と戻り値型を組み合わせたものが必要になる[5]。2つ目の点に関しては、多くの言語では一部の基本型の正確な表現を与えていないことを考えよ。例えばC言語における`int`型は16または32または64bit長である。同様に、Haskellも`Int`は少なくとも<code>[-2<sup>29</sup>,2<sup>29</sup>-1]</code>の範囲に渡ることしか保証していない(セクション[6.4](./6-predefined-types-and-classes.md)参照)。結果として、C言語の`int`の値が確かにHaskellで表現できるようにするために、`int`の表現と合っていることを保証してくれるような新しい型`CInt`を導入しなければならない。

外部名称の企画は呼び出し規約依存であるが、セクション[8.5](./8-foreign-function-interface.md)で説明される。また、外部言語に基づいた基本型のマーシャリングはセクション[8.6](./8-foreign-function-interface.md)で説明される。

## 文脈

与えられたHaskellのシステムに対して、我々は**Haskell文脈**というものを、Haskellのシステムの基礎となっている抽象機械の実行文脈と定義する。これは抽象機械のヒープ、スタック、レジスタと言ったものと、およびその具体的なアーキテクチャへの対応も含む。他の実行文脈は**外部文脈**と呼ぶ。一般に、Haskell文脈と与えられた外部文脈の間のデータフォーマットや呼び出し規約にはどんな互換性も仮定できない。ただしHaskellが明示的に特定のデータフォーマットを指定していた場合を除く。

外部関数インターフェイスの主要なゴールは、Haskell文脈と外部文脈の間にプログラム可能なインターフェイスを提供することである。結果としてHaskellのスレッドは外部文脈のデータにアクセスすることができ、外部文脈の中で関数を呼ぶことやまたその逆もできる。以下の定義では、外部文脈は通常呼び出し規約によって特定されるものとする。

### 言語間の型の一貫性

静的型をサポートする多くの外部言語が与えられたとき、Haskellの型の外部言語の型に対する一貫性が外部関数に対して強制できるかどうかという疑問がある。不幸にもこれは、一般には、Haskellシステムの実装者側による重大な投資(すなわち、専用の型チェッカーの実装)がなければ不可能である。例えば、C言語の呼び出し規約の場合には、他の唯一の方法はC言語のプロトタイプ宣言をHaskellの型から生成し、それをC言語のコンパイラにこのプロトタイプとインポートされた関数の記述されたC言語のヘッダーファイルで指定されたプロトタイプとをマッチさせることである。しかしながら、Haskellの型はこの方法を追求するには一部の情報がかけているのである。特に、Haskellの型はいつ`const`修飾子が必要になるかに関する情報を含んでいない。

結果として、ここでの定義はHaskellのシステムに外部型との一貫性をチェックすることを要求しない。しかしながら、Haskellのシステムは、理不尽な努力を要しない任意の言語との間で型の一貫性をチェックする方法を提供することが推奨される。

## 字句構造

FFIは単一のキーワード`foreign`と特別な識別子の集合を予約する。後者は
